{
  "name": "1. Atendente Motok√£o [v2]",
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "149f8496-42a2-44d8-85ce-27f4f8dd76d7"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "66990a98-3b3b-4f73-8936-c43c61e250e5",
      "name": "üîç Filtrar Mensagens",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2912,
        2336
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.body.conversation.id }}_{{ $json.body.id }}",
        "options": {}
      },
      "id": "23e2ea5b-768a-4899-9d94-12417475cb5c",
      "name": "‚ö° Cache Redis Check",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2224,
        2304
      ],
      "credentials": {
        "redis": {
          "id": "LEzG1SL5E566nY65",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.value }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isEmpty"
              },
              "id": "78adc0f8-c25a-4b59-aa85-67b3492f1874"
            },
            {
              "id": "f0158bac-2764-4160-8332-7e59c3516339",
              "leftValue": "={{ $('‚ö° Cache Redis Check').item.json.value }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "ef36d127-750b-4c86-8b52-ebdceb9b55b6",
      "name": "üÜï Nova Mensagem?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2000,
        2304
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.body.conversation.id }}_{{ $json.body.id }}",
        "value": "processed",
        "expire": true,
        "ttl": 3600
      },
      "id": "cb3b7bd7-e0aa-4549-a5d7-531ab13486da",
      "name": "‚úÖ Marcar Processado",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1776,
        2288
      ],
      "credentials": {
        "redis": {
          "id": "LEzG1SL5E566nY65",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chatwoot.motokaovirtual.com.br/api/v1/accounts/{{ $('üìã Extrair Informa√ß√µes').item.json.id_conta }}/conversations/{{ $('üìã Extrair Informa√ß√µes').item.json.id_conversa }}/toggle_typing_status",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "typing_status",
              "value": "on"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "id": "a4d81263-219c-40fb-a9a8-c405e4612e08",
      "name": "‚å®Ô∏è Status Digitando",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        64,
        2304
      ],
      "credentials": {
        "chatwootApi": {
          "id": "zmNL6YOUO92XXR5V",
          "name": "ChatWoot account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('üìã Extrair Informa√ß√µes').item.json.telefone }}",
        "tableName": "motokao_chat_memory"
      },
      "id": "6bee7928-9f91-4d30-8af7-bb6540c1f6d5",
      "name": "üß† Mem√≥ria de Conversa",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1,
      "position": [
        608,
        2560
      ],
      "credentials": {
        "postgres": {
          "id": "cudFrcal0TImhH5Y",
          "name": "Supabase Secret√°ria"
        }
      }
    },
    {
      "parameters": {
        "description": "=**Ferramenta de An√°lise e Estrat√©gia T√©cnica.** Use esta ferramenta como seu passo ZERO para qualquer solicita√ß√£o que n√£o seja trivial. Sua fun√ß√£o √© modelar seu racioc√≠nio de especialista.\n\n**CEN√ÅRIOS DE USO OBRIGAT√ìRIO:**\n- **Consultas Multi-Produto:** Cliente pede mais de um item.\n- **An√°lise de Compatibilidade Cruzada:** Pe√ßa vs. Moto, Pe√ßa vs. Pe√ßa.\n- **Dedu√ß√£o de Inten√ß√£o:** Quando o pedido √© um uso (ex: \"pneu pra fazer trilha\") e n√£o um produto espec√≠fico.\n- **Planejamento de Busca:** Antes de qualquer busca, para definir os termos exatos a serem usados.\n\n**PROTOCOLO DE SA√çDA OBRIGAT√ìRIO:**\nSua sa√≠da DEVE seguir estritamente o seguinte formato de Markdown:\n\n**An√°lise:** [Aqui voc√™ descreve sua interpreta√ß√£o da necessidade real e completa do cliente.]\n**Plano de A√ß√£o:**\n1.  **Passo 1:** [Descreva a primeira a√ß√£o que voc√™ vai tomar, ex: 'Usar a ferramenta X para buscar Y'.]\n2.  **Passo 2:** [Descreva a segunda a√ß√£o, se houver.]\n3.  **...**\n**Valida√ß√£o:** [Descreva o que voc√™ precisa confirmar ou a hip√≥tese que est√° testando com seu plano.]\n\n**Exemplo:**\n**An√°lise:** O cliente precisa do kit completo de transmiss√£o (coroa, corrente, pinh√£o) para a moto Honda Bros 160, ano 2020.\n**Plano de A√ß√£o:**\n1.  **Passo 1:** Usar `buscar_produtos_motokao` com o termo \"coroa Bros 160 2020\".\n2.  **Passo 2:** Usar `buscar_produtos_motokao` com o termo \"corrente Bros 160 2020\".\n3.  **Passo 3:** Usar `buscar_produtos_motokao` com o termo \"pinh√£o Bros 160 2020\".\n4.  **Passo 4:** Consolidar os resultados e apresentar ao cliente.\n**Valida√ß√£o:** Preciso confirmar a disponibilidade e o pre√ßo de cada um dos tr√™s componentes para o modelo e ano exatos."
      },
      "id": "4d7e82ff-cef9-4335-8590-4030be6a0412",
      "name": "ü§î Ferramenta de Racioc√≠nio",
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        1392,
        2560
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chatwoot.motokaovirtual.com.br/api/v1/accounts/{{ $('üìã Extrair Informa√ß√µes').item.json.id_conta }}/conversations/{{ $('üìã Extrair Informa√ß√µes').item.json.id_conversa }}/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.content }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            }
          ]
        },
        "options": {}
      },
      "id": "c0a315f7-ee73-4e88-9d17-47206154ee42",
      "name": "üì§ Enviar Mensagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1392,
        2320
      ],
      "credentials": {
        "chatwootApi": {
          "id": "zmNL6YOUO92XXR5V",
          "name": "ChatWoot account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "recebendo-mensagem-motokao",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3120,
        2336
      ],
      "id": "dc7c1948-1214-4764-82d6-4857955b73f9",
      "name": "üéØ Webhook Chatwoot",
      "webhookId": "003c4b22-55e7-4897-a3e0-c8e1a3ad5540"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagem_final }}",
        "options": {
          "systemMessage": "=HOJE √â: {{ $now.format('FFFF') }}\n\n\n\n# AGENTE DE ATENDIMENTO **Motok√£o**\n\n**Fun√ß√£o:** Assistente virtual para atendimento e suporte t√©cnico  \n\n**Objetivo Prim√°rio:**\n\n- Responder perguntas sobre produtos e servi√ßos. Apenas assuntos relacionados √† empresa.\n\n- Consultar bancos de dados veotoriais em tempo real.\n\n- Escalar casos complexos para humanos com a ferramenta 'Escalar humano'.\n\n**Tom:** Seja direto, educado, prestativo e sem enrola√ß√µes.\n\n\n\n## üèÅ CONTEXTO OPERACIONAL\n\n- **Especializa√ß√£o / Escopo:**\n\n - Manuten√ß√£o **preventiva** (antes da falha) e **corretiva** (p√≥s-falha).\n\n - **Especializa√ß√£o:** atendemos motos **100‚Äì400cc**, qualquer moto fora dessa faixa precisamos consultar com o mecanico.  \n\n - **Hor√°rio de funcionamento:** Segunda a sexta das **7:30h √†s 18h**; **s√°bado e domingo n√£o abrimos**.\n\n\n\n- **Limites de Atua√ß√£o:**  \n\n - ‚ùå N√£o dar instru√ß√µes mec√¢nicas (o assistente entende o tema, mas n√£o fornece passo a passo t√©cnico).\n\n - ‚ùå N√£o diagnosticar problemas sem dados suficientes ‚Äî pe√ßa para trazer a moto para analisarmos melhor.\n\n - ‚ùå N√£o revele o nosso SKU para o cliente.\n\n - ‚ùå N√£o √© necess√°rio informar a quantidade de estoque dispon√≠vel.\n\n - ‚ùå N√£o insira muitos assuntos na conversa; foque apenas no que o cliente precisa, um assunto de cada vez.\n\n - ‚ùå N√£o d√™ valores de m√£o de obra; diga que vai verificar com o respons√°vel e transfira para um humano.\n\n\n\n### üö¶ Fluxo de Atendimento ‚Äî Chain of Thought\n\n\n\n1) Sauda√ß√£o\n\n\n\n2) Quando o cliente pedir pre√ßo, entenda e capture os dados ess√™nciais apenas uma vez (modelo da moto e ano). Em seguida, pergunte se o cliente quer o valor da pe√ßa ou produto j√° instalado ou se quer o valor apenas da pe√ßa.\n\n\n\n3) Se for **s√≥ a pe√ßa**\n\n- [Consultar banco de dados \"produtos\" e confirmar modelo/ano exatos]\n\n- Se encontrado: \"Encontrei **[PE√áA]** para **[MOTO/ANO]** por **R$ [PRE√áO]**.\"\n\n- Complementos √∫teis:\n\n - (Se houver varia√ß√µes): \"Temos essas op√ß√µes: [VARIA√á√ïES QUE FIZEREM SENTIDO, N√ÉO FALE DE PE√áAS ALEAT√ìRIAS].\"\n\n\n\n4) Se for **pe√ßa + instala√ß√£o**\n\n- \"Para te passar o valor instalado preciso confirmar a m√£o de obra com a oficina. Vou te transferir agora para um atendente.\" [Transferir para humano]\n\n\n\n5) Encerramento\n\n- \"Posso te ajudar em mais alguma coisa?\"\n\n\n\n#### Regras r√°pidas (evite erro)\n\n- N√£o invente pre√ßo/estoque.\n\n- Tudo que o cliente perguntar que n√£o tiver informa√ß√£o no system prompt, fa√ßa a busca RAG no banco de dados vetorial 'faq' a resposta pode estar l√°, n√£o exite em usar essa ferramenta, ela √© extremamente ess√™ncial.\n\n\n\n### Pol√≠ticas de Escalonamento\n\n- Reclama√ß√£o de servi√ßo feito por n√≥s.\n\n- Falha na consulta (tente novamente e escale na 2¬™ falha).\n\n- Pedido de or√ßamento complexo, com muitas pe√ßas ou envolvendo m√£o de obra.\n\n- Quando o cliente provavelmente quiser fazer or√ßamento para seguro.\n\n\n\n## ‚öôÔ∏è FERRAMENTAS OPERACIONAIS\n\n### 1. `faq` (Banco de Dados Supabase)\n\n- **Uso:** Consultar para perguntas gerais (Use sempre que n√£o tiver a resposta no system prompt).\n\n\n\n### 2. `produtos` (Banco de Dados Supabase)\n\n- **Uso:** Acione ao detectar interesse em **saber mais sobre uma pe√ßa** (detalhes, compatibilidade, pre√ßo).\n\n\n\n## MODO DE USAR AS FERRAMENTAS\n\n### 1. `faq`\n\nUse para perguntas gerais. Sempre que algo n√£o estiver no system prompt ou no hist√≥rico da conversa, use essa ferramenta para confirmar detalhes sobre a d√∫vida do cliente; caso n√£o encontre, **fa√ßa a transfer√™ncia para um humano**.\n\n\n\n### 2. `produtos` ‚Äî Fluxo de uso da ferramenta\n\n1. **Entender o pedido do cliente**\n\n  - Identifique a pe√ßa solicitada.\n\n  - Liste poss√≠veis **sin√¥nimos, abrevia√ß√µes e descri√ß√µes equivalentes**.\n\n2. **Analisar a motocicleta**\n\n  - Confirme **modelo** e **ano** exatos informados pelo cliente.\n\n3. **Pesquisar no cat√°logo**\n\n  - Utilize **sin√¥nimos + modelo + ano** como filtros.\n\n  - Priorize correspond√™ncias **exatas de ano**; se n√£o houver, verifique **anos adjacentes** (ex.: 22...24 quando o cliente busca 2023).\n\n4. **Quando n√£o houver o ano exato**\n\n  > ‚ÄúEncontrei a pe√ßa **X** para sua moto. Mas preciso confirmar com o mec√¢nico se ela serve no **[ANO]** da sua moto.‚Äù\n\n5. **Padr√£o de t√≠tulo de produto**\n\n  **NOME DA PE√áA [√†s vezes com abrevia√ß√£o] + MOTO DE APLICA√á√ÉO (ANO) + OUTRAS MOTOS COMPAT√çVEIS + MARCA [√†s vezes indispon√≠vel]**\n\n  **Exemplo:** `KIT RELA√á√ÉO CG160 16...22/BROS160 18...22 DID`\n\n  *Lembrete:* a pe√ßa necess√°ria pode estar listada como compat√≠vel com outros modelos (ex.: pedido para Bros 160 pode aparecer na descri√ß√£o da CG 160).\n\n\n\n## Pol√≠ticas da empresa\n\n- **Entregas:** N√£o fazemos **entregas pela loja f√≠sica dentro da cidade**. **Se o cliente morar em outra cidade podemos fazer o envio atrav√©s de transportadora ou Mercado Livre**.\n\n- **Atendimento:** N√£o fazemos agendamento; trabalhamos por **ordem de chegada**.\n\n- **Instala√ß√£o de pe√ßas:** N√£o instalamos pe√ßas que **n√£o** foram compradas com a gente.\n\n- **Pagamentos (balc√£o presencial):**\n\n - Parcelamos compras no **cart√£o em at√© 3x sem juros** (balc√£o).\n\n - **Desconto:** 5% no **dinheiro** √† vista ou 3% no **Pix** (somente para pagamentos no balc√£o).\n\n\n\n### Pol√≠tica de Pe√ßas\n\n**Posi√ß√£o oficial:** Trabalhamos **exclusivamente com pe√ßas paralelas de alta qualidade**. S√£o op√ß√µes de **custo consideravelmente menor** e **qualidade muito semelhante** √†s originais. Selecionamos **marcas confi√°veis** para evitar dor de cabe√ßa para o cliente e empresa.\n\n\n\n**O que o agente deve fazer se o cliente perguntar sobre qualidade de pe√ßas**\n\n- ‚úÖ Dizer que s√≥ oferecemos pe√ßas **paralelas de alta qualidade**.\n\n- ‚úÖ Destacar **bom custo-benef√≠cio** e **qualidade equivalente**.\n\n- ‚úÖ Refor√ßar que **somos criteriosos na escolha das marcas**.\n\n\n\n**O que o agente n√£o deve fazer**\n\n- ‚ùå **N√£o** oferecer pe√ßas originais nem sugerir que conseguimos sob demanda.\n\n- ‚ùå **N√£o** prometer que a pe√ßa √© ‚Äúid√™ntica √† original‚Äù; prefira ‚Äúqualidade **muito semelhante**/equivalente‚Äù.\n\n- ‚ùå **N√£o** citar marcas espec√≠ficas se n√£o estiverem no contexto/dados.\n\n\n\n**Frases modelo (use e adapte)**\n\n- ‚ÄúTrabalhamos **somente com pe√ßas paralelas de alta qualidade**, com **custo bem mais baixo** e **qualidade muito semelhante** √† original.‚Äù\n\n- ‚ÄúSelecionamos **apenas marcas confi√°veis** para garantir durabilidade e evitar problemas futuros para o cliente e empresa.‚Äù\n\n- ‚ÄúN√£o oferecemos pe√ßa original; nossa **linha √© paralela premium**, com **excelente custo-benef√≠cio**.‚Äù\n\n\n\n**Se o cliente pedir pe√ßa original**\n\n- Responder: ‚ÄúNo momento trabalhamos **exclusivamente com pe√ßas paralelas de alta qualidade**. Posso verificar a op√ß√£o equivalente para a pe√ßa que voc√™ precisa?‚Äù\n\n\n\n- **Garantia:** segue a legisla√ß√£o vigente de 90 dias e cobre apenas **defeitos de fabrica√ß√£o**, n√£o por mal uso.\n\n- **Pol√≠tica de vendas e trocas:**\n\n - N√£o vendemos **pe√ßas usadas**.\n\n - N√£o realizamos **devolu√ß√£o de pe√ßas** ap√≥s instala√ß√£o.\n\n - N√£o aceitamos trocas como forma de pagamento.\n\n- **Hor√°rio de funcionamento:** Segunda a sexta das **7:30h √†s 18h**; **s√°bado e domingo n√£o abrimos**.\n\n- **Encomendas:** n√£o trabalhamos com encomendas sem **pagamento antecipado**.\n\n- **Servi√ßos n√£o realizados:** n√£o fazemos **pintura, funilaria ou envelopamento**.\n\n- **Execu√ß√£o dos servi√ßos:** manuten√ß√£o preventiva e corretiva realizadas apenas em nossa **oficina pr√≥pria**.\n\n- **Reserva de pe√ßas:** atendimento no balc√£o por ordem de chegada; **sem reserva**.\n\n\n\n### Pr√°ticas internas da empresa\n\n- **Antes de passar o valor de uma pe√ßa**, pergunte ao cliente se ele **quer apenas a pe√ßa** ou **a pe√ßa instalada**.  \n\n - Se quiser **s√≥ a pe√ßa**: passe o **pre√ßo**.\n\n - Se quiser **instalada**: **transfira para um humano**.\n\n - Se o cliente j√° tiver informado o modelo da moto, por√©m sem o ano, enfatize que voc√™ precisa do ano para fazer melhor a consulta, mas n√£o pe√ßa o modelo da moto novamente."
        }
      },
      "id": "e173846d-fd92-4de1-a7a7-89d9877c8812",
      "name": "ü§ñ Agente Motok√£o Principal",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        768,
        2320
      ]
    },
    {
      "parameters": {
        "model": "text-embedding-ada-002",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        736,
        2720
      ],
      "id": "7063feb6-07a9-4627-858f-b27ceee20f74",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "aGijCClKIFF3AhEo",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-ada-002",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1056,
        2720
      ],
      "id": "9ef800fd-4007-47d3-ac2e-33ba6be73273",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "aGijCClKIFF3AhEo",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega a resposta do agente de IA do n√≥ anterior\nconst textoAgente = $('ü§ñ Agente Motok√£o Principal').item.json.output;\n\n// Pega os dados de identifica√ß√£o do primeiro n√≥ do fluxo\nconst infoMensagem = $('üìã Extrair Informa√ß√µes').item.json;\n\n// --- In√≠cio da Formata√ß√£o ---\n// Substitui **palavra** por *palavra*\nlet textoFormatado = textoAgente.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\n// Remove o caractere '#'\ntextoFormatado = textoFormatado.replace(/#/g, '');\n// --- Fim da Formata√ß√£o ---\n\n// Retorna um novo objeto com TUDO o que o pr√≥ximo n√≥ precisa\nreturn {\n  content: textoFormatado,\n  id_conta: infoMensagem.id_conta,\n  id_conversa: infoMensagem.id_conversa\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        2320
      ],
      "id": "d851491a-d9fe-4006-8094-c4ff33c9efd9",
      "name": "Formatador de texto"
    },
    {
      "parameters": {
        "jsCode": "// Extrair informa√ß√µes da mensagem\nconst message = $('üîç Filtrar Mensagens').first().json.body;\nconst content = message.content || '';\n\n// Verifica o tipo de anexo\nconst attachment = message.attachments?.[0];\nconst hasAudio = attachment?.file_type === 'audio';\nconst hasImage = attachment?.file_type === 'image';\nconst attachmentUrl = attachment?.data_url;\n\nconst SEU_TELEGRAM_CHAT_ID = \"991616326\";\nconst URL_BASE_CHATWOOT = \"https://chatwoot.motokaovirtual.com.br\";\n\nreturn {\n  id_mensagem: message.id,\n  id_conta: message.account?.id,\n  id_conversa: message.conversation.id,\n  telefone: message.sender?.phone_number,\n  nome_cliente: message.sender?.name || 'Cliente',\n  mensagem: content,\n  mensagem_de_audio: hasAudio,\n  mensagem_de_imagem: hasImage, // Novo campo adicionado\n  anexo_url: attachmentUrl, // URL unificada para qualquer anexo\n  timestamp: message.created_at,\n  etiquetas: message.conversation?.labels || [],\n  telegram_chat_id: SEU_TELEGRAM_CHAT_ID,\n  url_chatwoot: URL_BASE_CHATWOOT\n};"
      },
      "id": "598870b3-e5cd-45c2-ae08-d3a1fca02976",
      "name": "üìã Extrair Informa√ß√µes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        2288
      ]
    },
    {
      "parameters": {
        "description": "Use esta ferramenta OBIGATORIAMENTE como sua √∫nica op√ß√£o para transferir o atendimento para um agente humano. Chame esta ferramenta SEMPRE que o cliente pedir para falar com uma pessoa, expressar frustra√ß√£o (ex: \"voc√™ n√£o entende\"), reclamar de um produto/servi√ßo, ou se a solicita√ß√£o for complexa demais para as outras ferramentas.",
        "workflowId": {
          "__rl": true,
          "value": "DeE5G6KVYJ2j7F2X",
          "mode": "list",
          "cachedResultName": "Transferir para um humano (Motok√£o)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $('üìã Extrair Informa√ß√µes').item.json.telefone }}",
            "nome": "={{ $('üìã Extrair Informa√ß√µes').item.json.nome_cliente }}",
            "ultima_mensagem": "={{ $('üìù Preparar Mensagem1').item.json.mensagem_final }}",
            "id_conta": "={{ $('üìã Extrair Informa√ß√µes').item.json.id_conta }}",
            "id_conversa": "={{ $('üìã Extrair Informa√ß√µes').item.json.id_conversa }}",
            "telegram_chat_id": "={{ $('üìã Extrair Informa√ß√µes').item.json.telegram_chat_id }}\n",
            "url_chatwoot": "={{ $('üìã Extrair Informa√ß√µes').item.json.url_chatwoot }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ultima_mensagem",
              "displayName": "ultima_mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_conta",
              "displayName": "id_conta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id_conversa",
              "displayName": "id_conversa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "url_chatwoot",
              "displayName": "url_chatwoot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1568,
        2560
      ],
      "id": "f3a8e9a6-40e5-450b-b14b-2978ede68a18",
      "name": "Escalar humano"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "faq",
        "toolDescription": "=Use esta ferramenta para responder perguntas gerais sobre a empresa, como hor√°rio de funcionamento, localiza√ß√£o, formas de pagamento, garantia e servi√ßos oferecidos. N√ÉO use para buscar produtos ou pe√ßas.",
        "tableName": {
          "__rl": true,
          "value": "faq",
          "mode": "list",
          "cachedResultName": "faq"
        },
        "topK": 8,
        "includeDocumentMetadata": false,
        "options": {
          "queryName": "match_faq"
        }
      },
      "id": "773e8156-c40b-44d1-8278-d130dc2585f4",
      "name": "faq",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        1056,
        2560
      ],
      "credentials": {
        "supabaseApi": {
          "id": "TtEWGIst9q5NtCn8",
          "name": "Supabase Motok√£o"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "produtos",
        "toolDescription": "=Use esta ferramenta para consultar informa√ß√µes sobre produtos, pe√ßas, SKUs, pre√ßos e estoque da Motok√£o. SEMPRE use esta ferramenta quando a pergunta do cliente for sobre a disponibilidade, compatibilidade ou pre√ßo de um item. N√ÉO use para perguntas gerais sobre a empresa.",
        "tableName": {
          "__rl": true,
          "value": "produtos",
          "mode": "list",
          "cachedResultName": "produtos"
        },
        "topK": 8,
        "includeDocumentMetadata": false,
        "options": {
          "queryName": "match_produtos"
        }
      },
      "id": "044fd5f9-5f76-411c-92f9-9b67b14917b9",
      "name": "produtos",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        736,
        2560
      ],
      "credentials": {
        "supabaseApi": {
          "id": "TtEWGIst9q5NtCn8",
          "name": "Supabase Motok√£o"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        448,
        2560
      ],
      "id": "e0990ab6-b9cc-4af7-a3b0-7af07c89840c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "aGijCClKIFF3AhEo",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "mensagem_final",
              "stringValue": "={{ \n(() => {\n  const t = (v) => (v ?? '').toString().trim();\n\n  // Sempre existe\n  const info = $('üìã Extrair Informa√ß√µes1').first().json || {};\n  const isAudio = !!info.mensagem_de_audio; // vem do Extrair Info\n\n  // Se N√ÉO for √°udio, tenta pegar s√≥ a √öLTIMA mensagem da fila\n  if (!isAudio) {\n    try {\n      const fila = $('üéØ Verificar Posi√ß√£o na Fila').all();\n      if (fila.length) {\n        const ult = fila[fila.length - 1];\n        const msg = t(ult.json?.mensagem);\n        if (msg) return msg;\n      }\n    } catch (e) { /* n√≥ n√£o executou? tudo bem */ }\n  }\n\n  // Se for √°udio (ou texto da fila n√£o veio), tenta a transcri√ß√£o\n  try {\n    const tx = $('Transcrever audio1').first(); // nome exato do n√≥\n    const txText = t(tx?.json?.text);\n    if (txText) return txText;\n  } catch (e) { /* n√≥ n√£o executou? segue o baile */ }\n\n  // Fallback: conte√∫do bruto\n  return t(info.mensagem);\n})()\n}}"
            }
          ]
        },
        "options": {}
      },
      "id": "02bf61be-09ee-4a59-9eec-25e64d1ecfe2",
      "name": "üìù Preparar Mensagem1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        272,
        2304
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1760,
        2464
      ],
      "id": "1338353f-7737-43fa-b7c9-94c338f4bc27",
      "name": "Sem Pr√≥ximo Passo  "
    },
    {
      "parameters": {
        "url": "={{ $json.audio_url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        2352
      ],
      "id": "9a13e7e1-e576-4307-be63-65f27ee7b18c",
      "name": "Download √°udio",
      "credentials": {
        "chatwootApi": {
          "id": "zmNL6YOUO92XXR5V",
          "name": "ChatWoot account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -608,
        2352
      ],
      "id": "2c25cc29-ba17-4581-8cf9-5f844289cfdb",
      "name": "Transcrever audio",
      "credentials": {
        "openAiApi": {
          "id": "aGijCClKIFF3AhEo",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const b = item.binary?.data;\n  if (!b) throw new Error('Sem bin√°rio em \"data\"');\n  // For√ßa metadados reconhec√≠veis pela OpenAI\n  b.fileName = b.fileName || 'audio.ogg';\n  b.mimeType = 'audio/ogg';\n  return item;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        2352
      ],
      "id": "6041b784-3eb8-470f-a916-7b02bb53adbd",
      "name": "Code"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9a7e16f-b6e4-45d7-846d-92dcb3117593",
                    "leftValue": "={{ $json.mensagem_de_audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "√Åudio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "12a7b5a4-7423-4868-afbb-346354a8e9a5",
                    "leftValue": "={{ $json.mensagem_de_imagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1312,
        2272
      ],
      "id": "8bf97b2c-887a-48de-9379-01409c03ed97",
      "name": "Tipo de mensagem"
    },
    {
      "parameters": {},
      "id": "27c829ff-1348-4027-9822-85e340c697a3",
      "name": "Unificar Caminhos",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        -128,
        2304
      ]
    },
    {
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "mensagem_final",
              "stringValue": "={{ $('Transcrever audio').item.json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2c24c58f-401d-49d6-bb36-f9a1254344fe",
      "name": "Preparar Transcri√ß√£o",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        -400,
        2352
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chatwoot.motokaovirtual.com.br/api/v1/accounts/{{ $json.body.account.id }}/conversations/{{ $json.body.conversation.id }}/assignments",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"assignee_id\": 3\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2464,
        2304
      ],
      "id": "53c09b66-c38b-47bc-a5bb-7912fb034d91",
      "name": "‚ûï Atribuir √† IA",
      "credentials": {
        "chatwootApi": {
          "id": "zmNL6YOUO92XXR5V",
          "name": "ChatWoot account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff2cc635-0071-41de-ab27-fbcf7d026386",
              "leftValue": "={{ $json.body.conversation.meta.assignee?.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "daf23cb1-5afe-4115-a7f7-bc02d2d02c65",
              "leftValue": "={{ $json.body.conversation.meta.assignee?.id }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2704,
        2320
      ],
      "id": "0c3dcc2e-92e5-44fe-becf-d6026680f6fa",
      "name": "ü§ñ J√° tem agente?"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2704,
        2480
      ],
      "id": "eeef9579-e1eb-4a22-b52a-f68c9d7d7a8d",
      "name": "Sem Pr√≥ximo Passo"
    },
    {
      "parameters": {
        "jsCode": "// Pega a √∫ltima mensagem da fila (input do n√≥ anterior)\nconst ultima_mensagem_da_fila = $input.last();\n\n// Pega a mensagem que iniciou este workflow\nconst mensagem_do_workflow = $('üìã Extrair Informa√ß√µes').first();\n\n// Extrai os IDs para compara√ß√£o\nconst id_fila = ultima_mensagem_da_fila.json.id_mensagem;\nconst id_workflow = mensagem_do_workflow.json.id_mensagem;\n\n// --- CORRE√á√ÉO APLICADA AQUI ---\n// Comparamos ambos os valores como texto (string) para evitar conflito de tipo.\nif (String(id_fila) !== String(id_workflow)) {\n  // Se os IDs forem diferentes, √© uma mensagem encavalada. Para o fluxo.\n  return [];\n}\n\n// Se os IDs forem iguais, a mensagem √© a correta. Deixa o fluxo continuar.\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        2176
      ],
      "id": "806ae92b-2e03-4d23-994f-53f5a307ffeb",
      "name": "Mensagem encavalada?",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $json.telefone }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -752,
        2176
      ],
      "id": "6db1a7c0-1cb1-4785-aa09-ca00eeec64f1",
      "name": "Buscar mensagens",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "XzWN5wFlJQx4ABHd",
          "name": "Supabase Motok√£o"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "telefone",
              "value": "={{ $json.telefone }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -400,
        2176
      ],
      "id": "0491cfe3-4b38-4b75-88ce-2031bb2b44b8",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "cudFrcal0TImhH5Y",
          "name": "Supabase Secret√°ria"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -912,
        2176
      ],
      "id": "ea04a12d-c50a-4f49-8430-714f6eba3713",
      "name": "Esperar",
      "webhookId": "689b51a0-89fe-459d-a560-a59c79797611"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $json.telefone }}",
            "mensagem": "={{ $json.mensagem }}",
            "timestamp": "={{ $json.timestamp }}",
            "id_mensagem": "={{ $json.id_mensagem }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1072,
        2176
      ],
      "id": "8472be2c-0ca8-4a28-8af9-4c32ae9dd303",
      "name": "Enfileirar mensagem.",
      "credentials": {
        "postgres": {
          "id": "XzWN5wFlJQx4ABHd",
          "name": "Supabase Motok√£o"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "a38c4262-180a-4f9c-aa66-ab21caea1ef3",
              "leftValue": "={{ $('üéØ Webhook Chatwoot').item.json.body.conversation.labels }}",
              "rightValue": "mecanico",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        464,
        2304
      ],
      "id": "406f9ca2-6157-4085-b64d-a1e29ec67834",
      "name": "If"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagem_final }}",
        "options": {
          "systemMessage": "=HOJE √â: {{ $now.format('FFFF') }}\n\n# AGENTE DE ATENDIMENTO **Motok√£o**\n**Fun√ß√£o:** Assistente virtual para atendimento para mec√¢nicos no atacado\n\n**Objetivo Prim√°rio:**\n- Passe o valor das pe√ßas que os mec√¢nicos pedirem utilizando a ferramenta 'produtos' vector store.\n- Escalar casos complexos para humanos com a ferramenta 'Escalar humano'.\n**Tom:** Extremamente direto, pe√ßa as informa√ß√µes que precisar e seja direto na hora de passar o pre√ßo.\n\n**ATEN√á√ÉO**\n- Os mec√¢nicos tem um desconto de 25% do pre√ßo de venda que voc√™ encontrar no banco de dados 'produtos' vector store, portanto, se quando o cliente pedir pe√ßa 'X' voc√™ vai mentalizar sinonimos para a pe√ßa que o mecanico quer, vai procurar a pe√ßa que o cliente pediu de forma vetorizada no banco de dados, e vai passar apenas o valor com desconto para o mecanico, por exemplo, a pe√ßa que encontrou custa R$100,00 voc√™ vai pegar esse valor, substrair 25% e passar o resultado para o mec√¢nico, no caso seria de R$75,00.\n- Algumas categorias de produtos tem descontos diferentes, s√£o elas:\n  Pneus: 15% de desconto\n\n- Fluxo de uso da ferramenta 'produtos'\n1. **Entender o pedido do cliente**\n   - Identifique a pe√ßa solicitada.  \n   - Liste poss√≠veis **sin√¥nimos, abrevia√ß√µes e descri√ß√µes equivalentes**.\n2. **Analisar a motocicleta**\n   - Confirme **modelo** e **ano** exatos informados pelo cliente.\n3. **Pesquisar no cat√°logo**  \n   - Utilize **sin√¥nimos + modelo + ano** como filtros.  \n   - Priorize correspond√™ncias **exatas de ano**; se n√£o houver, verifique **anos adjacentes** (ex.: 22...24 quando o cliente busca 2023).\n4. **Quando n√£o houver o ano exato**  \n   > ‚ÄúEncontrei a pe√ßa **X** para sua moto. Mas preciso confirmar com o mec√¢nico se ela serve no **[ANO]** da sua moto.‚Äù\n5. **Padr√£o de t√≠tulo de produto**  \n   **NOME DA PE√áA [√†s vezes com abrevia√ß√£o] + MOTO DE APLICA√á√ÉO (ANO) + OUTRAS MOTOS COMPAT√çVEIS + MARCA [√†s vezes indispon√≠vel]**  \n   **Exemplo:** `KIT RELA√á√ÉO CG160 16...22/BROS160 18...22 DID`  \n   *Lembrete:* a pe√ßa necess√°ria pode estar listada como compat√≠vel com outros modelos (ex.: pedido para Bros 160 pode aparecer na descri√ß√£o da CG 160)."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        784,
        2096
      ],
      "id": "fbbd4b9f-a211-4207-81fe-a03d42c8c0d6",
      "name": "Agente IA para MEC√ÇNICOS"
    },
    {
      "parameters": {
        "jsCode": "// Pega a resposta do agente de IA do n√≥ anterior\nconst textoAgente = $('Agente IA para MEC√ÇNICOS').item.json.output;\n\n// Pega os dados de identifica√ß√£o do primeiro n√≥ do fluxo\nconst infoMensagem = $('üìã Extrair Informa√ß√µes').item.json;\n\n// --- In√≠cio da Formata√ß√£o ---\n// Substitui **palavra** por *palavra*\nlet textoFormatado = textoAgente.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\n// Remove o caractere '#'\ntextoFormatado = textoFormatado.replace(/#/g, '');\n// --- Fim da Formata√ß√£o ---\n\n// Retorna um novo objeto com TUDO o que o pr√≥ximo n√≥ precisa\nreturn {\n  content: textoFormatado,\n  id_conta: infoMensagem.id_conta,\n  id_conversa: infoMensagem.id_conversa\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        2096
      ],
      "id": "ec7fe158-f920-4c28-bba5-cf21ffa0c7cc",
      "name": "Formatador de texto (Mec√¢nico)"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "text": "O que tem nessa imagem? Voc√™ faz parte de um workflow de atendimento ao cliente em uma loja e oficina de motos, portanto, quaisquer imagens provavelmente ser√° relacionada a isso.",
        "imageUrls": "={{ $json.anexo_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1072,
        2512
      ],
      "id": "9608871d-6676-455e-8bfe-e842d6ace84b",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "aGijCClKIFF3AhEo",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "fields": {
          "values": [
            {
              "name": "conteudo_imagem",
              "stringValue": "={{ $json.content }}"
            }
          ]
        },
        "options": {}
      },
      "id": "18ff03d3-6519-4a07-9306-a9d56218dc08",
      "name": "Transcri√ßao Imagem",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        -400,
        2512
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "üîç Filtrar Mensagens": {
      "main": [
        [
          {
            "node": "ü§ñ J√° tem agente?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sem Pr√≥ximo Passo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ö° Cache Redis Check": {
      "main": [
        [
          {
            "node": "üÜï Nova Mensagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üÜï Nova Mensagem?": {
      "main": [
        [
          {
            "node": "‚úÖ Marcar Processado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sem Pr√≥ximo Passo  ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Marcar Processado": {
      "main": [
        [
          {
            "node": "üìã Extrair Informa√ß√µes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚å®Ô∏è Status Digitando": {
      "main": [
        [
          {
            "node": "üìù Preparar Mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üß† Mem√≥ria de Conversa": {
      "ai_memory": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Agente IA para MEC√ÇNICOS",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "ü§î Ferramenta de Racioc√≠nio": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Enviar Mensagem": {
      "main": [
        []
      ]
    },
    "üéØ Webhook Chatwoot": {
      "main": [
        [
          {
            "node": "üîç Filtrar Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ Agente Motok√£o Principal": {
      "main": [
        [
          {
            "node": "Formatador de texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "produtos",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "faq",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Formatador de texto": {
      "main": [
        [
          {
            "node": "üì§ Enviar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Extrair Informa√ß√µes": {
      "main": [
        [
          {
            "node": "Tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escalar humano": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente IA para MEC√ÇNICOS",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "faq": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "produtos": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente IA para MEC√ÇNICOS",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Agente IA para MEC√ÇNICOS",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üìù Preparar Mensagem1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download √°udio": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever audio": {
      "main": [
        [
          {
            "node": "Preparar Transcri√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Transcrever audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem": {
      "main": [
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download √°udio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificar Caminhos": {
      "main": [
        [
          {
            "node": "‚å®Ô∏è Status Digitando",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Transcri√ß√£o": {
      "main": [
        [
          {
            "node": "Unificar Caminhos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ûï Atribuir √† IA": {
      "main": [
        [
          {
            "node": "‚ö° Cache Redis Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ J√° tem agente?": {
      "main": [
        [
          {
            "node": "‚ûï Atribuir √† IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Unificar Caminhos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Agente IA para MEC√ÇNICOS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ü§ñ Agente Motok√£o Principal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente IA para MEC√ÇNICOS": {
      "main": [
        [
          {
            "node": "Formatador de texto (Mec√¢nico)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatador de texto (Mec√¢nico)": {
      "main": [
        [
          {
            "node": "üì§ Enviar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Transcri√ßao Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcri√ßao Imagem": {
      "main": [
        [
          {
            "node": "Unificar Caminhos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "54d9bffd-006a-4531-9d69-54ad400c04e0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "cc8408cceae7fa0f8b71136a7f42ebc73548c779275a4018abe7f6d69be1e4cd"
  },
  "id": "VVSZiUFHTGpppso9",
  "tags": []
}
